<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tstat-DPDK Readme</title>
<link rel="stylesheet" href="https://stackedit.io/res-min/themes/base.css" />
<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body><div class="container"><h1 id="tstat-dpdk">Tstat-DPDK</h1>



<h1 id="1-description-of-the-software">1. Description of the software</h1>

<p>This program is a particular version of Tstat which uses Intel Data Plane Development Kit to retreive packets from network interfaces (NICs). <br>
It uses a multicore approach to achieve high speed. So it’s important to know the number of cores you CPU has. <br>
It starts several <strong>indipendent instances of Tstat</strong>. Each instance will be fed by a portion of the incoming traffic. <br>
So the each Tstat instance produces its own output in different directories. <br>
* To understand Tstat please read: <a href="http://tstat.polito.it/HOWTO.shtml">http://tstat.polito.it/HOWTO.shtml</a> <br>
* For information about DPDK please read: <a href="http://dpdk.org/doc">http://dpdk.org/doc</a> <br>
* For information about this Readme file and Tstat-DPDK please write to <a href="mailto:martino.trevisan@studenti.polito.it">martino.trevisan@studenti.polito.it</a></p>



<h1 id="2-requirements">2. Requirements</h1>

<ul>
<li>A machine with 82599 based network interfaces.</li>
<li>A Debian based Linux distribution with kernel &gt;= 2.6.3</li>
<li>Linux kernel headers: to install type</li>
</ul>



<pre class="prettyprint"><code class="language-bash hljs ">    <span class="hljs-built_in">sudo</span> apt-get install linux-headers-$(uname -r)</code></pre>

<ul>
<li>Several package needed before installing this software: <br>
<ul><li>DPDK needs: <code>make, cmp, sed, grep, arch, glibc.i686, libgcc.i686, libstdc++.i686, glibc-devel.i686, python</code></li>
<li>Tstat needs: <code>libpcap-dev, rrdtool, librrd-dev, cpufrequtils, autoconf, libtool, subversion</code></li></ul></li>
</ul>



<h1 id="3-installation">3. Installation</h1>



<h2 id="31-install-dpdk">3.1 Install DPDK</h2>

<p>Install DPDK 1.7.1. With other versions is not guaranted it works properly. <br>
Make the enviroment variable <code>RTE_SDK</code> and <code>RTE_TARGET</code> to point respectively to DPDK installation directory and compilation target. <br>
For documentation and details see <a href="http://dpdk.org/doc/intel/dpdk-start-linux-1.7.0.pdf">http://dpdk.org/doc/intel/dpdk-start-linux-1.7.0.pdf</a></p>



<pre class="prettyprint"><code class="language-bash hljs ">    wget http://dpdk.org/browse/dpdk/snapshot/dpdk-<span class="hljs-number">1.7</span>.<span class="hljs-number">1</span>.tar.gz
    tar xzf dpdk-<span class="hljs-number">1.7</span>.<span class="hljs-number">1</span>.tar.gz
    <span class="hljs-built_in">cd</span> dpdk-<span class="hljs-number">1.7</span>.<span class="hljs-number">1</span>
    <span class="hljs-keyword">export</span> RTE_SDK=$(<span class="hljs-built_in">pwd</span>)
    <span class="hljs-keyword">export</span> RTE_TARGET=x86_64-native-linuxapp-gcc
    make install T=<span class="hljs-variable">$RTE_TARGET</span>
    <span class="hljs-built_in">cd</span> ..</code></pre>

<p><strong>NOTE:</strong> if you are running on a i686 machine, please use <code>i686-native-linuxapp-gcc</code> as <code>RTE_TARGET</code></p>



<h2 id="32-install-tstat-dpdk">3.2 Install Tstat-DPDK</h2>

<p>This operation requires super user privileges.</p>



<pre class="prettyprint"><code class="language-bash hljs ">    svn co http://tstat.polito.it/svn/software/tstat/branches/tstat-dpdk/
    <span class="hljs-built_in">cd</span> tstat-dpdk/tstat-<span class="hljs-number">3.0</span>r648
    ./autogen.sh
    ./configure --enable-libtstat
    make
    <span class="hljs-built_in">sudo</span> make install
    <span class="hljs-built_in">cd</span> ../one_copy_cluster_dpdk
    make clean &amp;&amp; make
    <span class="hljs-built_in">cd</span> ../..</code></pre>

<p><strong>NOTE 1:</strong> be sure that when running <code>./configure --enable-libtstat</code> you get this output</p>



<pre class="prettyprint"><code class=" hljs haml">-<span class="ruby">------------------------------------------------
</span>  tstat Version 3.0
  -<span class="ruby">lpcap -lpthread -lm  -lrrd
</span>
  Prefix: '/usr/local'

  Package features:
    -<span class="ruby"> pcap      yes
</span>    -<span class="ruby"> zlib      no
</span>    -<span class="ruby"> rrd       yes
</span>    -<span class="ruby"> libtstat  yes
</span>-<span class="ruby">-------------------------------------------------</span></code></pre>

<p>This means that <code>libpcap</code> and <code>rrdtool</code> have been detected and <code>libtstat</code> compilation enabled.</p>

<p><strong>NOTE 2:</strong> if, when running Tstat-DPDK, you encounter an error like this</p>



<pre class="prettyprint"><code class=" hljs vhdl">    error <span class="hljs-keyword">while</span> loading <span class="hljs-keyword">shared</span> libraries: libtstat.so<span class="hljs-number">.0</span>: cannot <span class="hljs-keyword">open</span> <span class="hljs-keyword">shared</span> object <span class="hljs-keyword">file</span>: No such <span class="hljs-keyword">file</span> <span class="hljs-keyword">or</span> directory</code></pre>

<p>run this command to make the enviroment to find <code>libstat</code> shared object:</p>



<pre class="prettyprint"><code class="language-bash hljs ">    <span class="hljs-keyword">export</span> LD_LIBRARY_PATH=/usr/local/lib</code></pre>



<h1 id="4-configuration-of-the-machine">4. Configuration of the machine</h1>

<p>Before running Tstat-DPDK there are few things to do:</p>



<h2 id="41-reserve-a-big-number-of-hugepages-to-dpdk">4.1 Reserve a big number of hugepages to DPDK</h2>

<p>The commands below reserve 6144 hugepages. Reserve about 512 * N, where N is the number of cores of your machine. The size of each huge page is 2MB. Check to have enough RAM on your machine.</p>



<pre class="prettyprint"><code class="language-bash hljs ">    <span class="hljs-built_in">sudo</span> su
    <span class="hljs-built_in">echo</span> <span class="hljs-number">6144</span> &gt;/sys/kernel/mm/hugepages/hugepages-<span class="hljs-number">2048</span>kB/nr_hugepages
    mkdir -p /mnt/huge
    mount -t hugetlbfs nodev /mnt/huge</code></pre>



<h2 id="42-set-cpu-on-performance-governor">4.2 Set CPU on performance governor</h2>

<p>To achieve the best performances, your CPU must run always at the highest speed. You need to have installed <code>cpufrequtils</code> package.</p>



<pre class="prettyprint"><code class="language-bash hljs ">    <span class="hljs-built_in">sudo</span> cpufreq-set -r -g performance</code></pre>



<h2 id="43-bind-the-interfaces-you-want-to-use-with-dpdk-drivers">4.3  Bind the interfaces you want to use with DPDK drivers</h2>

<p>It means that you have to load DPDK driver and associate it to you network interface. Remember to set <code>RTE_SDK</code> and <code>RTE_TARGET</code>.</p>



<pre class="prettyprint"><code class="language-bash hljs ">    <span class="hljs-built_in">sudo</span> modprobe uio
    <span class="hljs-built_in">sudo</span> insmod <span class="hljs-variable">$RTE_SDK</span>/<span class="hljs-variable">$RTE_TARGET</span>/kmod/igb_uio.ko
    <span class="hljs-built_in">sudo</span> <span class="hljs-variable">$RTE_SDK</span>/tools/dpdk_nic_bind.py --bind=igb_uio $(<span class="hljs-variable">$RTE_SDK</span>/tools/dpdk_nic_bind.py --status | sed -rn <span class="hljs-string">'s,.* if=([^ ]*).*igb_uio *$,\1,p'</span>)</code></pre>

<p>To check if your network interfaces have been properly set by the Intel DPDK enviroment run:</p>



<pre class="prettyprint"><code class="language-bash hljs ">    <span class="hljs-built_in">sudo</span> <span class="hljs-variable">$RTE_SDK</span>/tools/dpdk_nic_bind.py --status</code></pre>

<p>You should get an output like this, which means that the first two interfaces are running under DPDK driver, while the third is not:</p>



<pre class="prettyprint"><code class=" hljs asciidoc"><span class="hljs-header">Network devices using DPDK-compatible driver
============================================</span>
0000:04:00.0 <span class="hljs-emphasis">'Ethernet Controller 10-Gigabit X540-AT2'</span> drv=igb<span class="hljs-emphasis">_uio unused=
0000:04:00.1 'Ethernet Controller 10-Gigabit X540-AT2' drv=igb_</span>uio unused=
<span class="hljs-header">Network devices using kernel driver
===================================</span>
0000:03:00.0 <span class="hljs-emphasis">'NetXtreme BCM5719 Gigabit Ethernet PCIe'</span> if=eth0 drv=tg3 unused=igb<span class="hljs-emphasis">_uio *Active*</span></code></pre>



<h2 id="44-set-up-tstat-configuration">4.4  Set up Tstat configuration</h2>

<p>In the directory <code>installation-dir/one_copy_cluster_dpdk/tstat-conf</code> there is a set of files: <code>tstat00.conf</code>, <code>tstat01.conf</code> ecc… <br>
Those are the configuration files of each Tstat process. Configure it as you prefer; the default configuration includes all plugins, RRDTool engine and CryptoPAn anonymization. <br>
Having one configuration file for each Tstat istance let you to specify manually RRDTool directory. This is necessary to make it work because each instance needs an its own directory.  <br>
By deafult these directory are rrd_fastweb_liveXX where XX is the number of the instance. Anyway RRD usage is not mandatory.</p>



<h1 id="5-usage">5. Usage</h1>



<h2 id="51-how-to-start-it">5.1 How to start it</h2>

<p>To start Tstat-DPDK <strong>go in <code>installation-dir/one_copy_cluster_dpdk</code>.</strong> Then use the provided script to start it. <br>
Decide how many instances of Tstat-DPDK you want to run in parallel: a Tstat instance needs two cores. <br>
If you want to start 2 instances, type:</p>



<pre class="prettyprint"><code class="language-bash hljs ">    ./scripts/start_2_istances.sh</code></pre>

<p>The system approximately each one seconds prints statistics about its performances, a line each instance. <br>
The information are about average, maximum, and standard deviation of per-packet processing time. There is the number of TCP and UDP flows closed. <br>
The output includes also the incoming rate in Mpps and the eventual packets’ losing rate (in case of losses). You can see also the occupation of the internal buffer. <br>
The ouput has got this form.</p>



<pre class="prettyprint"><code class=" hljs http"><span class="hljs-attribute">Instance</span>: <span class="hljs-string">0 Avg: 1.023us Max: 35.127us StdDev: 14.452 TCP cl.: 42 UDP cl.: 213 Rate: 0.897Mpps, Loss: 0Mpps Buffer occupation:   0%</span>
<span class="hljs-attribute">Instance</span>: <span class="hljs-string">1 Avg: 1.045us Max: 44.345us StdDev: 45.713 TCP cl.: 37 UDP cl.: 175 Rate: 0.813Mpps, Loss: 0Mpps Buffer occupation:   0%</span></code></pre>



<h2 id="52-how-to-stop-it">5.2 How to stop it</h2>

<p>To stop Tstat-DPDK, type:</p>



<pre class="prettyprint"><code class="language-bash hljs ">    ./scripts/quit_instances.sh</code></pre>

<p>The system will quit and it will print overall statistics on its working divided by network interface and by instance. <br>
The output has this form.</p>



<pre class="prettyprint"><code class=" hljs matlab">PORT: <span class="hljs-number">0</span> Rx: <span class="hljs-number">0</span> Drp: <span class="hljs-number">0</span> Tot: <span class="hljs-number">0</span> Perc: -<span class="hljs-built_in">nan</span><span class="hljs-comment">%</span>
    Queue <span class="hljs-number">0</span> Rx: <span class="hljs-number">0</span> Drp: <span class="hljs-number">0</span> Tot: <span class="hljs-number">0</span> Perc: -<span class="hljs-built_in">nan</span><span class="hljs-comment">%</span>
    Queue <span class="hljs-number">1</span> Rx: <span class="hljs-number">0</span> Drp: <span class="hljs-number">0</span> Tot: <span class="hljs-number">0</span> Perc: -<span class="hljs-built_in">nan</span><span class="hljs-comment">%</span>
PORT: <span class="hljs-number">1</span> Rx: <span class="hljs-number">0</span> Drp: <span class="hljs-number">0</span> Tot: <span class="hljs-number">0</span> Perc: -<span class="hljs-built_in">nan</span><span class="hljs-comment">%</span>
    Queue <span class="hljs-number">0</span> Rx: <span class="hljs-number">0</span> Drp: <span class="hljs-number">0</span> Tot: <span class="hljs-number">0</span> Perc: -<span class="hljs-built_in">nan</span><span class="hljs-comment">%</span>
    Queue <span class="hljs-number">1</span> Rx: <span class="hljs-number">0</span> Drp: <span class="hljs-number">0</span> Tot: <span class="hljs-number">0</span> Perc: -<span class="hljs-built_in">nan</span><span class="hljs-comment">%</span>

ISTANCE: <span class="hljs-number">0</span> Rx: <span class="hljs-number">0</span> Drp: <span class="hljs-number">0</span> Tot: <span class="hljs-number">0</span> Perc: -<span class="hljs-built_in">nan</span><span class="hljs-comment">%</span>
TSTAT STATISTICS:
Total packets: <span class="hljs-number">0</span>
TCP flows: <span class="hljs-number">0</span>
UDP flows: <span class="hljs-number">0</span>
Time elapsed: <span class="hljs-number">2880.317</span>s

ISTANCE: <span class="hljs-number">1</span> Rx: <span class="hljs-number">0</span> Drp: <span class="hljs-number">0</span> Tot: <span class="hljs-number">0</span> Perc: -<span class="hljs-built_in">nan</span><span class="hljs-comment">%</span>
TSTAT STATISTICS:
Total packets: <span class="hljs-number">0</span>
TCP flows: <span class="hljs-number">0</span>
UDP flows: <span class="hljs-number">0</span>
Time elapsed: <span class="hljs-number">2879.215</span>s</code></pre>



<h2 id="53-log-files-directory">5.3 Log files directory</h2>

<p>Tstat produces several logs file for different events seen on the network. <br>
Log files are keep separate for each instance and they are put in <code>installation-dir/one_copy_cluster_dpdk/tstatXX.log.out</code> where <code>XX</code> is the number of Tstat instance. <br>
It cannot be modified. <br>
RRD files directory is specified in the configuration files of Tstat.</p>



<h2 id="54-statistics-of-the-system">5.4 Statistics of the system</h2>

<p>In the directory <code>installation-dir/one_copy_cluster_dpdk/tstat-stats</code> there is a set of file called <code>statsXX.txt</code>. <br>
Each instance writes in its own file (the <code>XX</code> in the name of the file is its number) statistics while it is running. <br>
There are 3 columns which are respectively the mean, the max and the standard deviation of the per packet processing time.</p></div></body>
</html>